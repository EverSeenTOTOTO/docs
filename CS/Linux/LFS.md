# LFS(Linux From Scratch)

è®°å½•å®è·µLFSçš„è¸©å‘ä¸æ”¶è·ã€‚å½“å‰ä½¿ç”¨çš„LFSç‰ˆæœ¬ä¸º11.1.24ã€‚

## ä¸€ã€æ£€æŸ¥å®¿ä¸»ç³»ç»Ÿè½¯ä»¶åŒ…çš„æ”¯æŒ

è§2.2èŠ‚ã€Šå®¿ä¸»ç³»ç»Ÿéœ€æ±‚ã€‹ï¼Œå®˜æ–¹æä¾›äº†ä¸€ä¸ªæ£€æŸ¥çš„è„šæœ¬ï¼Œè·‘ä¸€ä¸‹ä½œå¯¹æ¯”è°ƒæ•´å³å¯ã€‚

1.  `ERROR: /bin/sh does not point to bash`

    æˆ‘çš„`/bin/sh`æŒ‡å‘çš„æ˜¯`dash`ï¼Œéœ€è°ƒæ•´ä¸ºæŒ‡å‘`bash`ã€‚

    ```bash
    sudo ln -svf /bin/bash /bin/sh
    ```

    æˆ‘çš„`/usr/bin/awk`æŒ‡å‘çš„æ˜¯`mawk`ï¼Œéœ€è¦è°ƒæ•´ä¸ºæŒ‡å‘`gawk`ï¼ŒåŒç†ã€‚

2.  `makeinfo: command not found`

    åœ¨ubuntuæœºå™¨ä¸Šï¼Œéœ€è¦å®‰è£…`texinfo`ã€‚

## äºŒã€å‡†å¤‡ç”¨äºLFSçš„åˆ†åŒº

æ¨èä¸º LFS é€‰æ‹©â¼€ä¸ªå¯â½¤çš„ç©ºåˆ†åŒºï¼Œæˆ–è€…åœ¨æœ‰å……â¾œæœªåˆ’åˆ†ç©ºé—´çš„æƒ…å†µä¸‹ï¼Œåˆ›å»ºâ¼€ä¸ªæ–°åˆ†åŒºã€‚åˆ†åŒºå¯ä»¥ä½¿ç”¨`fdisk`å’Œ`parted`å·¥å…·ï¼Œå¦å¤–æœ‰ä¸ª`gparted`çš„GUIç‰ˆæœ¬æŒºå¥½ç”¨çš„ã€‚
å®é™…ä¸Šåœ¨åšè¿™ä¸€æ­¥çš„æ—¶å€™æˆ‘è¯•å›¾ç¼©å°æ­£åœ¨ä½¿ç”¨çš„ç³»ç»Ÿåˆ†åŒºï¼ŒæˆåŠŸæå´©äº†ç”µè„‘ğŸ¶ã€‚å¥½åœ¨é‡è¦çš„æ•°æ®éƒ½æœ‰å¤‡ä»½ï¼Œæƒè¡¡äº†ä¸€ä¸‹ä¹‹åå¹²è„†é‡è£…ä¸‹ç³»ç»Ÿï¼Œæ¸…çˆ½å¤šäº†ã€‚åœ¨é‡è£…çš„æ—¶å€™é¢„ç•™ä¸‹ç»™LFSçš„ç£ç›˜ç©ºé—´å³å¯ã€‚

åœ¨ç³»ç»Ÿåˆ†åŒºè¡¨æŸåæ— æ³•å¯åŠ¨çš„æƒ…å†µä¸‹é‡è£…ç³»ç»Ÿä¸éº»çƒ¦ï¼Œå‚è€ƒæ­¥éª¤å¦‚ä¸‹ï¼š

1.  åˆ©ç”¨å¦å¤–ä¸€å°ç”µè„‘åˆ¶ä½œä¸€ä¸ªUSBçš„Live CDå¯åŠ¨ç›˜
2.  è°ƒæ•´ç”µè„‘çš„BIOS bootè®¾ç½®ï¼Œä¼˜å…ˆä»USBå¯åŠ¨
3.  è¿›å…¥åœ¨USBä¸Šçš„ç³»ç»Ÿï¼Œè¿™æ—¶åŸºäºGPTåˆ†åŒºè¡¨çš„å¤‡ä»½ç‰¹æ€§å…¶å®å¯ä»¥å°è¯•ä¿®å¤æŸåçš„GPTåˆ†åŒºè¡¨ï¼Œç„¶è€Œæˆ‘è¿˜æ²¡å­¦ä¼šğŸ˜†ã€‚å¦‚æœè¦æ ¼å¼åŒ–SSDç£ç›˜å¯ä»¥å‚è€ƒ[Arch Wikiçš„æ–‡æ¡£](https://wiki.archlinux.org/title/Solid_state_drive/Memory_cell_clearing)ï¼Œå¦‚æœè¦é‡æ–°åˆ†åŒºå¯ä»¥çœ‹ä¸€ä¸‹[çº¢å¸½çš„æ–‡æ¡£](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/8/html/managing_file_systems/assembly_getting-started-with-partitions_managing-file-systems#assembly_viewing-the-partition-table_assembly_getting-started-with-partitions)å’Œ[ArchWikiçš„æ–‡æ¡£](https://wiki.archlinux.org/title/Partitioning_\(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87\)#GUID_%E5%88%86%E5%8C%BA%E8%A1%A8)ã€‚

å¦å¤–ä¸€äº›å€¼å¾—è®°å½•çš„ç‚¹ï¼š

1.  [è¿™ç¯‡æ–‡ç« ](https://segmentfault.com/a/1190000020850901)å€¼å¾—ä¸€è¯»ï¼Œå¯¹å¾ˆå¤šåŸºç¡€æ¦‚å¿µéƒ½æœ‰ä»‹ç»ã€‚

2.  ç½‘ä¸Šå¾ˆå¤šæ•™ç¨‹éƒ½æ˜¯SATAé©±åŠ¨çš„ç£ç›˜ï¼Œå¸¸è§çš„æ˜¾ç¤ºåç§°æ˜¯`/dev/sda`ï¼Œæˆ‘çš„æ˜¯NVMeé©±åŠ¨çš„ç£ç›˜ï¼Œè®¾å¤‡æ ‡è¯†`/dev/nvme0n1`ï¼Œæ ¼å¼åŒ–çš„æ—¶å€™å¯ä»¥ä½¿ç”¨`nvme-cli`æ ¼å¼åŒ–ã€‚

3.  å¦‚æœä¸ç¡®å®šæ€ä¹ˆåˆ†ï¼Œä¸€èˆ¬æ¥è¯´ä¸€ä¸ª`FAT32`æ ¼å¼çš„bootåˆ†åŒºï¼ˆä»…é€‚ç”¨äºUEFIï¼ŒæŒ‚è½½åˆ°`/boot/efi`ï¼‰ï¼Œé€šå¸¸æ˜¯MBå•ä½ï¼ˆæˆ‘ä½¿ç”¨çš„PopOsç³»ç»Ÿè¦æ±‚500+MBï¼‰ã€ä¸€ä¸ª`ext4`æ ¼å¼çš„ä¸»åˆ†åŒºï¼ˆä»…é€‚ç”¨äºflashè®¾å¤‡ä¾‹å¦‚SSDå’ŒUç›˜ï¼Œä¼ ç»Ÿçš„ç¡¬ç›˜ä¸€èˆ¬æ˜¯NTFSæ ¼å¼ï¼ŒæŒ‚è½½åˆ°`/`ï¼‰ï¼Œä¸€ä¸ªå¯é€‰çš„`linux swap`æ ¼å¼çš„swapåˆ†åŒºï¼Œswapåˆ†åŒºä¸éœ€è¦å¤ªå¤§ï¼ˆæˆ‘è®¾ç½®çš„4Gï¼Œå¸¸å¹´ç”¨ä¸ä¸Šï¼‰ï¼Œå¯ä»¥[åŠ¨æ€è°ƒæ•´](/CS/Linux/swap.md)çš„ã€‚

    ä¸‹é¢æ˜¯æˆ‘åˆ†åŒºä¹‹åè¿›å…¥`parted`äº¤äº’é¡µé¢`p all`çš„è¾“å‡ºç»“æœï¼š

    ```bash
    Disk /dev/nvme0n1: 512GB
    Sector size (logical/physical): 512B/512B

    Number  Start   End     Size    File system     Name  Flags
     1      1049kB  538MB   537MB   fat32                 boot, esp
     2      429GB   512GB   82.6GB  ext4
     3      538MB   4833MB  4295MB  linux-swap(v1)        swap
     4      4833MB  429GB   425GB   ext4
    ```

    ä¸‹é¢æ˜¯`fdisk -l`çš„è¾“å‡ºï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ä¸¤è¾¹æ˜¾ç¤ºçš„åˆ†åŒºå¤§å°ä¸ä¸€æ ·ï¼Œè¿˜æ²¡ææ‡‚æ˜¯ä¸ºä»€ä¹ˆâ€¦â€¦æ€»æ„Ÿè§‰æ˜¯ä¹‹å‰çåˆ†åŒºçš„æ—¶å€™å¯¼è‡´å“ªé‡ŒæŸåäº†ï¼Œå‡­ç©ºè’¸å‘äº†30å¤šGBçš„å®¹é‡ï¼š

    `/dev/nvme0n1p1`æ˜¯ESPï¼ˆEFI System Partitionï¼‰ï¼Œ`/dev/nvme0n1p2`æ˜¯é¢„ç•™ç»™LFSçš„ç©ºé—´ï¼Œ`/dev/nvme0n1p4`æ˜¯å®¿ä¸»ç³»ç»Ÿæ‰€åœ¨åˆ†åŒºï¼Œ`/dev/nvme0n1p3`æ˜¯äº¤æ¢å†…å­˜ã€‚

    ```bash
    Device             Start        End   Sectors   Size Type
    /dev/nvme0n1p1      2048    1050623   1048576   512M EFI System
    /dev/nvme0n1p2 838864896 1000214527 161349632  76.9G Linux filesystem
    /dev/nvme0n1p3   1050624    9439230   8388607     4G Linux swap
    /dev/nvme0n1p4   9439232  838864895 829425664 395.5G Linux filesystem
    ```

    :::info
    åç»­çœ‹äº†ä¸‹ï¼Œå¯èƒ½å’Œ`fdisk`ä¸`parted`ä½¿ç”¨çš„å•ä½ä¸åŒæœ‰å…³ï¼ŒSSDå‚å•†ä½¿ç”¨1000ä½œä¸ºè¿›åˆ¶ï¼Œè€Œæˆ‘ä»¬å¸¸è¯´GBã€MBéƒ½æ˜¯ä»¥1024ä¸ºè¿›åˆ¶ã€‚512GBçš„SSDæœ‰$\frac{512*1000^3}{1024^3}\approx 476.83GB$çš„å®é™…å®¹é‡ï¼Œä¸¥æ ¼ç®—çš„è¯å¯ä»¥åˆ©ç”¨æ‰‡åŒºæ•°$\frac{(1000214527-2048)*512}{1024^3}\approx 476.94GB$ï¼Œï¼ˆéœ€ç¡®è®¤è‡ªå·±çš„æ‰‡åŒºå¤§å°Sector sizeæ˜¯512Bï¼‰å·®ä¸å¤šã€‚[è¿™é‡Œ](http://www.jinbuguo.com/storage/ssd_usage.html)æœ‰ä¸€ç¯‡æ¯”è¾ƒå¥½çš„æ–‡æ¡£ã€‚
    :::

4.  åˆ†åŒºåLFSæ–‡æ¡£æ¨èå°†å…¶æŒ‚è½½åœ¨`/mnt/lfs`ä¸‹ï¼Œå¹¶ç¼–è¾‘`/etc/fstab`è®¾ç½®å¼€æœºæ—¶è‡ªåŠ¨æŒ‚è½½ã€‚

    `/etc/fstab`ç¼–è¾‘æ–°å¢çš„è¡Œï¼š

    ```bash
    /dev/nvme0n1p2 /mnt/lfs ext4 defaults 1 1
    ```

    ä¸‹é¢æ˜¯æŒ‚è½½ä¿¡æ¯`mount | column -t | grep nvme`ï¼š

    ```bash
    /dev/nvme0n1p4  on  /                          type  ext4             (rw,noatime,errors=remount-ro)
    /dev/nvme0n1p1  on  /boot/efi                  type  vfat             (rw,relatime,fmask=0077,dmask=0077,codepage=437,iocharset=iso8859-1,shortname=mixed,errors=remount-ro)
    /dev/nvme0n1p2  on  /mnt/lfs                   type  ext4             (rw,relatime)
    ```

5.  `parted`åˆ†åŒºçš„æ—¶å€™å¯ä»¥è®¾ç½®`unit s`ä»¥æ‰‡åŒºï¼ˆsectorï¼‰ä¸ºå•ä½ï¼Œä¹Ÿå¯ä»¥ç”¨`GB`ã€`GiB`æˆ–`%`ä½œä¸ºå•ä½ï¼Œä¸€èˆ¬èµ·å§‹çš„æ—¶å€™å¯èƒ½ä»¥æŸä¸ªæ‰‡åŒºèµ·å§‹ï¼Œåˆ†é…å¤šå°‘GBï¼Œæœ€åä¸€ä¸ªåˆ†åŒºä»¥100%ä¸ºç»“æŸä½ç½®é˜²æ­¢æµªè´¹ã€‚

6.  `blkid`å¯ä»¥æŸ¥çœ‹åˆ†åŒºçš„è¯¦ç»†ä¿¡æ¯`blkid -p /dev/nvme0n1p2`ã€‚

7.  [wiki](https://en.wikipedia.org/wiki/EFI_system_partition)ä¸Šæœ‰è¿™ä¹ˆä¸€å¥è¯ï¼šGUID åˆ†åŒºè¡¨(GPT) æ–¹æ¡ˆä¸­EFI ç³»ç»Ÿåˆ†åŒºçš„å…¨å±€å”¯ä¸€æ ‡è¯†ç¬¦(GUID) ä¸ºC12A7328-F81F-11D2-BA4B-00A0C93EC93Bã€‚é€šè¿‡`fdisk -x`å¯ä»¥å¾—åˆ°éªŒè¯ï¼š

    ```bash
    Device             Start        End   Sectors Type-UUID                            UUID                                 Name Attrs
    /dev/nvme0n1p1      2048    1050623   1048576 C12A7328-F81F-11D2-BA4B-00A0C93EC93B 32B1B505-0371-4CB0-96E9-10D30F8A8626
    ```

8.  è™½ç„¶ç°åœ¨æ™®éé‡‡ç”¨çš„éƒ½æ˜¯GPTåˆ†åŒºè¡¨å’ŒUEFIï¼Œä½†æ˜¯åœ¨äº†è§£BIOSå’ŒMBRçš„æ—¶å€™å¯¹äºä¸ºä»€ä¹ˆMBRåˆ†åŒºæœ€å¤§åªèƒ½è¯†åˆ«2TBç¡¬ç›˜å¾ˆæœ‰ç–‘é—®ã€‚çœ‹åˆ°å¾ˆå¤šæ–‡æ¡£è¦ä¹ˆè¯´æ¯ä¸ªåˆ†åŒºè¡¨é¡¹å ç”¨16ä¸ªå­—èŠ‚å¯¼è‡´çš„ï¼Œè¦ä¹ˆè¯´ä¸º32ä½ç³»ç»Ÿè®¾è®¡å¯¼è‡´çš„ï¼Œå«ç³Šå…¶è¾ã€‚çœŸæ­£çš„åŸå› æ˜¯MBRçš„åˆ†åŒºè¡¨é‡‡ç”¨4å­—èŠ‚æ•°æ¥å­˜å‚¨åˆ†åŒºæ‰‡åŒºæ•°ï¼Œæ‰€ä»¥èƒ½è¡¨ç¤ºçš„æœ€å¤§å®¹é‡ä¸º$2^{4*8}*512B = 2TB$ã€‚

## ä¸‰ã€ä¸‹è½½è½¯ä»¶åŒ…å’Œè¡¥ä¸ã€æ„å»º

ä½¿ç”¨å®˜æ–¹ç»™å‡ºçš„`wget-list`æ–‡ä»¶ä¸‹è½½æ¯”è¾ƒå¿«ï¼š<https://www.linuxfromscratch.org/lfs/downloads/stable/>ã€‚

```bash
wget --input-file=wget-list --continue --directory-prefix=$LFS/sources
```

ä¹‹åçš„å®‰è£…å’Œç¼–è¯‘æ­¥éª¤æ¯”è¾ƒæ¯ç‡¥ï¼Œä¸€ä¸ªä¸€ä¸ªæ¥çš„è¯å†æ—¶ä¸¤å¤©å·¦å³ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯äº¤å‰ç¼–è¯‘çš„ä¸€äº›åº“åœ¨åé¢è¿›å…¥chrootç¯å¢ƒé‡æ–°ç¼–è¯‘çš„æ—¶å€™æœ€å¥½é‡æ–°è§£å‹æ„å»ºã€‚

ä¸€äº›å€¼å¾—è®°å½•çš„ç‚¹ï¼š

1.  glibcå’Œkernelæ˜¯çµé­‚ã€‚è™½ç„¶LFSå› ä¸ºæ²¡æœ‰`rsync`ä¸æ¨èä½¿ç”¨linuxå†…æ ¸æºç æ ‘æä¾›çš„`make headers_install`ï¼Œä½†æ˜¯è¿™ä¸ª`headers_install`å‘½ä»¤æœ¬èº«è¿˜æœ‰ä¸€æ®µæ•…äº‹ï¼š<http://www.jinbuguo.com/kernel/header_story.html>ï¼›
2.  eudevå®‰è£…æ­¥éª¤é‡Œé¢çš„`make -f udev-lfs-20171102/Makefile.lfs install`æ˜¯LFSé¢„æä¾›çš„udevè§„åˆ™å’Œæ”¯æŒæ–‡ä»¶ï¼Œå’Œudevå¦‚ä½•å¤„ç†é©±åŠ¨è®¾å¤‡æœ‰å…³ã€‚å¯ä»¥æŸ¥é˜…ArchWikiä¸Šç›¸å…³çš„æ–‡æ¡£ï¼Œ[è¿™ç¯‡æ–‡ç« ](http://www.jinbuguo.com/kernel/device_files.html)ä¹Ÿå€¼å¾—ä¸€è¯»ã€‚
3.  ï¼ˆè§ç¬¬9.6ç« ï¼‰LFSä½¿ç”¨`sysvinit`çš„å¼•å¯¼æ¶æ„å¯åŠ¨ï¼ŒåŸºäºè¿è¡Œçº§åˆ«ï¼ˆrun-levelï¼‰çš„æ¦‚å¿µè€Œæ„å»ºã€‚åŒæ—¶LFSé¢„å…ˆæä¾›äº†LFS-Bootscriptsè„šæœ¬æ¥å¯åŠ¨å’Œåœæ­¢ç³»ç»Ÿã€‚æŸ¥çœ‹ä¸€ä¸‹LFS-BootscriptsåŒ…çš„Makefileå¯çŸ¥ï¼Œå®ƒä¼šæ‹·è´å„ç§å¯åŠ¨shellè„šæœ¬åˆ°`/etc/rc.d/`ä¸‹é¢å»ã€‚å…·ä½“çš„è„šæœ¬æ‰§è¡Œå¯ä»¥å‚è€ƒ9.6.2èŠ‚ã€‚å¦ä¸€ç§æµè¡Œçš„å¼•å¯¼æ¶æ„æ˜¯systemdï¼ŒLFSä¹Ÿæœ‰å¯¹åº”çš„ä¸€ä¸ªæ“ä½œæ‰‹å†Œç‰ˆæœ¬ã€‚è¿™é‡Œä¸ºäº†ç®€å•ä½¿ç”¨çš„æ˜¯sysvinitã€‚

## å››ã€å†…æ ¸å’Œgrubé…ç½®

åˆ°ç³»ç»Ÿé…ç½®å’Œgrubå¯åŠ¨é…ç½®çš„æ—¶å€™LFSæ–‡æ¡£æ˜¾å¾—å¾ˆæ‚ä¹±ï¼Œè€Œä¸”éœ€è¦å¯¹udevæœ‰ä¸€å®šäº†è§£ã€‚ä¸€äº›è®°å½•å¦‚ä¸‹ï¼š

1.  udevè®¾å¤‡å’Œé©±åŠ¨é…ç½®åŸºæœ¬æ²¡åŠ¨ï¼Œç­‰ç†Ÿæ‚‰äº†å†å»é…ç½®ï¼Œåœ¨LFSæ–‡æ¡£ä¸Šå®‰è£…eudevè½¯ä»¶åŒ…çš„æ—¶å€™é¢„å®‰è£…äº†ä¸€äº›è§„åˆ™ï¼Œåº”è¯¥è¶³å¤Ÿå¯åŠ¨å†…æ ¸äº†ï¼›

2.  é…ç½®å¯åŠ¨åˆ†åŒºæˆ‘å‚è€ƒBLFSæ–‡æ¡£é…ç½®UEFIå¯åŠ¨ï¼Œä¸­é€”åˆå®‰è£…æ„å»ºäº†è®¸å¤šè½¯ä»¶ä¸è¡¨ã€‚è¿™é‡Œæˆ‘è¿˜çŠ¯äº†ä¸€ä¸ªæ²™é›•é”™è¯¯ï¼ŒLFSæåˆ°å®¿ä¸»ç³»ç»Ÿå¦‚æœæœ‰å•ç‹¬çš„`/boot`åˆ†åŒºéœ€æ‰§è¡Œ`mount --bind /boot /mnt/lfs/boot`å°†LFSç³»ç»Ÿçš„`/boot`ç»‘å®šä¸ºè¯¥åˆ†åŒºå†æ‹·è´å†…æ ¸æ–‡ä»¶ï¼Œæˆ‘æ²¡æœ‰ç‹¬ç«‹çš„`/boot`åˆ†åŒºå´ä¹Ÿè¿™æ ·åšäº†ï¼Œä½¿å¾—LFSç³»ç»Ÿçš„`/boot`æŒ‡å‘äº†å®¿ä¸»ç³»ç»Ÿçš„`/boot`ï¼Œç»“æœå°†å¯¼è‡´ç³»ç»Ÿå¯åŠ¨æŒ‚è½½`/boot/efi`æ—¶æç¤ºæ‰¾ä¸åˆ°æŒ‚è½½ç‚¹`/boot`ï¼ˆå› ä¸ºLFSç³»ç»Ÿæ”¾ç½®åœ¨`/dev/nvme0n1p2`åˆ†åŒºï¼Œgrubé‡Œé¢çš„rootä¹Ÿæ˜¯è¿™ä¸ªï¼Œè€Œè¯¥åˆ†åŒºçš„`/boot`é‡Œé¢æ²¡ä¸œè¥¿ï¼Œå†…æ ¸æ–‡ä»¶å…¨è¢«æˆ‘æ‹·è´åˆ°å®¿ä¸»ç³»ç»Ÿçš„`/boot`å»äº†ï¼‰ã€‚æ­£ç¡®åšæ³•æ˜¯å†…æ ¸æ–‡ä»¶æ‹·è´åˆ°LFSç³»ç»Ÿçš„`/boot`ç›®å½•ï¼Œå¹¶å°†ESPï¼ˆEFI System Partitionï¼Œå³æˆ‘è¿™é‡Œçš„`/dev/nvme0n1p1`ï¼‰æŒ‚è½½åˆ°LFSç³»ç»Ÿçš„`/boot/efi`ã€‚ä¸‹é¢æ˜¯LFSç³»ç»Ÿçš„`/etc/fstab`é…ç½®ï¼Œå®é™…æˆ‘å†™çš„æ˜¯fs UUIDï¼š

    ```bash
    /dev/nvme0n1p1 /boot/efi  vfat defaults 0 1
    /dev/nvme0n1p2 / ext4 defaults 1 1
    ```

3.  è¿˜æœ‰ä¸€ä¸ªå¤§å‘å’Œå¯åŠ¨æ—¶æ ¹åˆ†åŒºæŒ‚è½½æœ‰å…³ï¼Œä¸€å¼€å§‹æˆ‘åœ¨grub.cfgé‡Œé¢å†™å…¥çš„å†…æ ¸å¼•å¯¼å‚æ•°æ˜¯`root=/dev/nvme0n1p2`ï¼Œä¼šå¯¼è‡´`kernel panic`ï¼Œæç¤ºæ‰¾ä¸åˆ°`/dev/nvme0n1p2`ï¼Œæ¢æˆfs UUIDä¹Ÿä¸è¡Œï¼ŒæŸ¥äº†ä¸‹[grubçš„æ–‡æ¡£](https://www.gnu.org/software/grub/manual/grub/html_node/Root-Identifcation-Heuristics.html)ä»¥ä¸ºæ˜¯åœ¨`GRUB_DISABLE_LINUX_PARTUUID`å’Œ`GRUB_DISABLE_LINUX_UUID`éƒ½é»˜è®¤`false`çš„æƒ…å†µä¸‹ï¼Œgrubé‡‡ç”¨part UUIDè€Œéfs UUIDå¯¼è‡´çš„ï¼Œæˆ‘æä¾›çš„æ˜¯fs UUIDã€‚å› æ­¤å¯ä»¥å‚è€ƒ[ArchWikiçš„æ–‡æ¡£](https://wiki.archlinux.org/title/Persistent_block_device_naming_\(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87\))è°ƒæ•´grubé…ç½®å‚æ•°`GRUB_DISABLE_LINUX_PARTUUID`å’Œ`GRUB_DISABLE_LINUX_UUID`ï¼Œè¦æ±‚ä½¿ç”¨fs UUIDã€‚å½“ç„¶é—®é¢˜ä¸æ˜¯è¿™ä¸ªï¼Œæ²¡æœ‰è§£å†³ã€‚éšåçŒœæµ‹æ˜¯udevçš„è§„åˆ™ä¸å¯¹æ— æ³•è¯†åˆ«åˆ°nvmeç£ç›˜é©±åŠ¨ï¼Œæ‹·è´äº†å®¿ä¸»æœº`/usr/lib/udev/rules.d`ä¸‹é¢çš„è§„åˆ™è¿‡å»ä¹Ÿä¸è¡Œï¼Œå¹¶ä¸”çœ‹äº†ä¸‹LFSæ–‡æ¡£æä¾›çš„è§„åˆ™æ˜¯æœ‰è¯†åˆ«nvmeè®¾å¤‡çš„ï¼ˆå¯ä»¥`grep nvme /lib/udev/rules.d`æŸ¥çœ‹ï¼‰çš„è§„åˆ™çš„ã€‚åˆæŸ¥äº†å¾ˆä¹…çš„æ–‡æ¡£ï¼Œç»“åˆä¸‹é¢çš„grubé…ç½®å®¿ä¸»æœºç³»ç»Ÿå’Œä½¿ç”¨å®¿ä¸»æœºç³»ç»Ÿå†…æ ¸çš„LFSç³»ç»Ÿå‡èƒ½å¤Ÿæ­£å¸¸å¯åŠ¨çš„ç°è±¡ï¼ŒçŒœæµ‹æ˜¯å†…æ ¸ç¼–è¯‘çš„æ—¶å€™æ²¡æœ‰å¼€å¯NVMEæ”¯æŒï¼Œäºæ˜¯å°è¯•é€šè¿‡è°ƒæ•´å†…æ ¸æ„å»ºé…ç½®å¼€å¯nvmeç›¸å…³çš„é…ç½®ï¼Œä¾ç„¶ä¸è¡ŒğŸ˜¿â€¦â€¦æœ€åç´¢æ€§æŠŠå®¿ä¸»æœºçš„å†…æ ¸ç»™copyè¿‡å»äº†ï¼Œå¹¶ä¸”æ²¿ç”¨äº†å®¿ä¸»æœºå†…æ ¸é…å¥—çš„initrd.imgï¼Œé‡å¯åç»ˆäºæˆåŠŸè¿›å…¥äº†LFSçš„ç»ˆç«¯ç•Œé¢ã€‚ç™½piaoè™½ç„¶å¼€å¿ƒï¼Œæ²¡ç”¨ä¸Šè‡ªå·±æ„å»ºçš„å†…æ ¸æ€»æ„Ÿè§‰å°‘äº†ç‚¹æ„æ€ï¼Œè¿™é‡Œçš„å¤±è´¥è¿˜éœ€è¦è¿›ä¸€æ­¥æ¢ç©¶ã€‚

    > åç»­åˆæŠ˜è…¾äº†ä¸¤å¤©ï¼Œç»“åˆä½¿ç”¨å®¿ä¸»æœºå†…æ ¸èƒ½è¿›å…¥LFSç³»ç»Ÿçš„ç°è±¡å’Œå¯åŠ¨æ—¶çš„ä¸€äº›æŠ¥é”™ï¼Œä»¥`initrd nvme`ä¸ºå…³é”®å­—æœç´¢ç»ˆäºçœ‹åˆ°äº†è››ä¸é©¬è¿¹ï¼ˆå®¿ä¸»ç³»ç»Ÿå’ŒLFSç³»ç»Ÿgrub.cfgé‡Œé¢kernelå‚æ•°é…ç½®åŸºæœ¬ä¸€è‡´ï¼Œå®¿ä¸»ç³»ç»Ÿçš„initrd.imgèƒ½å¤Ÿæ­£å¸¸æŒ‚è½½æ ¹åˆ†åŒºï¼Œè€Œä½¿ç”¨BLFSæä¾›çš„`mkinitramfs`è„šæœ¬ç”Ÿæˆçš„initrd.imgåˆ™ä¸èƒ½ï¼Œä¼°è®¡æ˜¯éœ€è¦`initrd.img`æ”¯æŒæŒ‚è½½`nvme`æ ¹åˆ†åŒºå•¥çš„ã€‚æœ€ç»ˆä½¿ç”¨çš„æ˜¯ä½¿ç”¨BLFSæåˆ°çš„dracutå·¥å…·å»åˆ›å»º`initrd.img`ï¼Œä¸‹é¢æ˜¯[dracut](https://mirrors.edge.kernel.org/pub/linux/utils/boot/dracut/dracut.html#_dracut_8)çš„é…ç½®ï¼š

    > :::code-group
    > ```bash [/etc/dracut.conf]
    > hostonly=no
    > hostonly_cmdline=no
    > persistent_policy=by-uuid
    > use_fstab=yes
    > sysloglvl=3
    > compress=xz
    > ```
    > :::

    > ä½¿ç”¨`dracut --kver 5.16.12 -c /etc/dracut.conf  -f`ç”Ÿæˆinird.imgå¹¶ä¸”æ‹·è´åˆ°`/boot`æ–‡ä»¶å¤¹é‡Œé¢å»ã€‚å†é‡å¯å°±å¯ä»¥è¿›å…¥LFSç³»ç»Ÿäº†ï¼Œè¿™æ—¶å€™ä½¿ç”¨çš„æ˜¯è‡ªå·±ç¼–è¯‘çš„å†…æ ¸ï¼Œèˆ’æœã€‚

4.  æœ€åæ˜¯æˆ‘çš„grub.cfgï¼Œå‚è€ƒ[ArchWikiçš„æ–‡æ¡£](https://wiki.archlinux.org/title/GRUB_\(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87\)#%E7%94%9F%E6%88%90%E4%B8%BB%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6)ç¼–å†™ï¼Œä¸­é€”ä¸ºäº†æ‰¾å‡ºæ ¹åˆ†åŒºæŒ‚è½½ä¸ä¸Šçš„é—®é¢˜æ·»åŠ äº†å¾ˆå¤šè°ƒè¯•å‚æ•°ï¼ŒLFSæ–‡æ¡£å¤ªæµ…æ˜¾äº†â€¦â€¦ä¸‹é¢çš„`Pop OS`æ˜¯åŸæœ‰çš„å®¿ä¸»ç³»ç»Ÿï¼Œåœ¨ç¬¬å››ä¸ªåˆ†åŒº`/dev/nvme0n1p4`æ‰€ä»¥`set root=(hd0,4)`ï¼š

    ```bash
    # Begin /boot/grub/grub.cfg

    set default=0
    set timeout=5
    serial --unit=0 --speed=9600
    terminal --timeout=5 serial console

    # set pager=1
    # set debug=all

    insmod part_gpt
    insmod ext2

    if loadfont /boot/grub/fonts/unicode.pf2; then
      set gfxmode=auto
      insmod all_video
      terminal_output gfxterm
    fi

    menuentry "Pop OS" {
     set root=(hd0,4)
     linux /boot/vmlinuz-5.16.11-76051611-generic root=UUID=01454fcc-c1a2-43b8-8d2c-c4f01a9bd671 ro
     initrd /boot/initrd.img
    }

    menuentry "Everseen LFS"  {
     set root=(hd0,2)
            linux /boot/vmlinuz-5.16.12-lfs-r11.1-24 root=UUID=a0f3219f-2875-4853-b7ec-b5ead88691bb rootflags=rw,relatime,discard,data=ordered rootfstype=ext4 panic=30 rd.shell rd.debug rd.udev.debug log_buf_len=1M console=tty0 console=ttyS0,9600 rd.retry=60 rd.timeout=120
     initrd /boot/initramfs-5.16.12.img
    }

    menuentry "Firmware Setup" {
      fwsetup
    }
    ```

å°ç»“ä¸€ä¸‹ï¼Œå­¦åˆ°çš„ä¸œè¥¿è¿˜æ˜¯å¾ˆå¤šçš„ã€‚ä¸ä»…å¯¹`/dev`ã€`/sys`è¿™äº›å¸¸è§çš„ç›®å½•å’Œç›®å½•é‡Œé¢çš„å†…å®¹æ˜¯æ€ä¹ˆæ¥çš„ã€éƒ½æ˜¯ä»€ä¹ˆä½œç”¨æœ‰äº†ä¸€å®šçš„äº†è§£ï¼Œä¹Ÿç†Ÿæ‚‰äº†ä¸å°‘æ¦‚å¿µå’Œå·¥å…·ï¼Œæ¯”å¦‚`MBR`ã€`GPT`ã€`fdisk`ã€`parted`ã€`grub`ã€`udev`ç­‰ï¼Œå¯¹å¦‚ä½•åˆ†åŒºã€æ‹¯æ•‘ç³»ç»Ÿä¹Ÿæ„ˆå‘åœ°å¾—å¿ƒåº”æ‰‹äº†ã€‚æœ€åæ„Ÿè°¢ä¸€ä¸‹ArchWikiçš„å„ä½ç»´æŠ¤è€…ï¼Œæ— æ•°æ¬¡æ•‘æˆ‘è‹¦å‘½çš„æœºå™¨äºæ°´ç«ğŸ˜„ã€‚
